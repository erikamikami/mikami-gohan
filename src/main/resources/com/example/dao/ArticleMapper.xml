<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.dao.ArticleMapper">

<select id="getArticleLimitThirty" resultType="com.example.entity.Article">
select * from article where display_flg = true order by create_date DESC
</select>

<select id="getArticle" parameterType="String" resultType="com.example.entity.Article">
select * from article 
where display_flg = true 
and unique_string = #{uniqueString} 
;
</select>

<resultMap id="detailArticleResultMap" type="com.example.entity.ArticleDetail">
    <id property="id" column="article_detail_id"/>
    <result property="articleId" column="article_id"/>
    <result property="articleDetailTypeId" column="article_detail_type_id"/>
    <result property="contents" column="contents" />
    <result property="caption" column="caption"/>
    <result property="externalLink" column="external_link"/>
    <result property="externalLinkOgpTitle" column="external_link_ogp_title" />
    <result property="externalLinkOgpDomain" column="external_link_ogp_domain"/>
    <result property="externalLinkOgpImageUrl" column="external_link_ogp_image_url" />
    <result property="externalLinkOgpGetDay" column="external_link_ogp_get_day"/>
    <result property="externalLinkOgpGetFlg" column="external_link_ogp_get_flg"/>
    <result property="displayFlg" column="display_flg" />
    <result property="sortOrder" column="sort_order"/>
    <result property="createDate" column="create_date"/>
    <result property="updateDate" column="update_date"/>
    
    <association property="article" javaType="com.example.entity.Article">
      <result property="uniqueString" column="unique_string"/>
      <result property="title" column="title"/>
      <result property="introduction" column="introduction"/>
    </association>
    
    <association property="recipe" javaType="com.example.entity.Recipe">
      <result property="id" column="recipe_id"/>
      <result property="title" column="recipe_title"/>
    </association>
    
</resultMap>

<select id="getArticleDetails" parameterType="String" resultMap="detailArticleResultMap">
select 
  a.unique_string,
  a.title,
  a.introduction,
  ad.id as article_detail_id,
  ad.article_id,
  ad.article_detail_type_id,
  ad.contents,
  ad.caption,
  ad.recipe_id,
  ad.external_link,
  ad.external_link_ogp_title,
  ad.external_link_ogp_domain,
  ad.external_link_ogp_image_url,
  ad.external_link_ogp_get_day,
  ad.external_link_ogp_get_flg,
  ad.display_flg,
  ad.sort_order,
  ad.create_date,
  ad.update_date,
  r.id as recipe_id,
  r.title as recipe_title
from article as a
left join article_detail as ad on a.id = ad.article_id and ad.display_flg = 'true'
left join recipe as r on ad.recipe_id = r.id and r.display_flg = 'true'
where 1 = 1
  and a.display_flg = 'true'
  and a.unique_string = #{uniqueString}
  and ad.display_flg = 'true'
order by ad.sort_order, ad.id
</select>

<update id="updateOgpData" parameterType="com.example.entity.ArticleDetail">
  UPDATE article_detail
  SET
    external_link_ogp_title = #{externalLinkOgpTitle},
    external_link_ogp_domain = #{externalLinkOgpDomain},
    external_link_ogp_image_url = #{externalLinkOgpImageUrl},
    external_link_ogp_get_day = #{externalLinkOgpGetDay},
    external_link_ogp_get_flg = 'true'
  WHERE id = #{id}
</update>

</mapper>